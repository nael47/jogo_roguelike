(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class T{canvas;ctx;constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Canvas with id ${t} not found`);this.canvas=e;const i=this.canvas.getContext("2d");if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}getContext(){return this.ctx}get width(){return this.canvas.width}get height(){return this.canvas.height}}class A{joystickBase;joystickStick;active=!1;startX=0;startY=0;currentX=0;currentY=0;MAX_RADIUS=50;axisX=0;axisY=0;isTouchActive=!1;constructor(){this.joystickBase=document.createElement("div"),this.joystickBase.id="joystick-base",this.joystickStick=document.createElement("div"),this.joystickStick.id="joystick-stick",this.joystickBase.appendChild(this.joystickStick),document.body.appendChild(this.joystickBase),this.joystickBase.style.display="none",this.setupListeners()}setupListeners(){window.addEventListener("touchstart",t=>{this.isTouchActive=!0,!t.target.closest(".card")&&t.target.closest("button")},{passive:!1}),document.addEventListener("touchstart",t=>this.handleTouchStart(t),{passive:!1}),document.addEventListener("touchmove",t=>this.handleTouchMove(t),{passive:!1}),document.addEventListener("touchend",t=>this.handleTouchEnd(t))}handleTouchStart(t){if(t.target.closest("#modal-layer")||t.target.closest("button"))return;t.preventDefault();const e=t.changedTouches[0];this.active=!0,this.startX=e.clientX,this.startY=e.clientY,this.currentX=this.startX,this.currentY=this.startY,this.joystickBase.style.display="block",this.joystickBase.style.left=`${this.startX-this.MAX_RADIUS}px`,this.joystickBase.style.top=`${this.startY-this.MAX_RADIUS}px`,this.joystickStick.style.transform="translate(0px, 0px)",this.updateAxis()}handleTouchMove(t){if(!this.active)return;t.preventDefault();const e=t.changedTouches[0];this.currentX=e.clientX,this.currentY=e.clientY,this.updateStickPosition(),this.updateAxis()}handleTouchEnd(t){this.active&&(this.active=!1,this.joystickBase.style.display="none",this.axisX=0,this.axisY=0)}updateStickPosition(){let t=this.currentX-this.startX,e=this.currentY-this.startY;if(Math.sqrt(t*t+e*e)>this.MAX_RADIUS){const s=Math.atan2(e,t);t=Math.cos(s)*this.MAX_RADIUS,e=Math.sin(s)*this.MAX_RADIUS}this.joystickStick.style.transform=`translate(${t}px, ${e}px)`}updateAxis(){let t=this.currentX-this.startX,e=this.currentY-this.startY;Math.abs(t)<10&&(t=0),Math.abs(e)<10&&(e=0),Math.sqrt(t*t+e*e)>0?(this.axisX=t/this.MAX_RADIUS,this.axisY=e/this.MAX_RADIUS,this.axisX=Math.max(-1,Math.min(1,this.axisX)),this.axisY=Math.max(-1,Math.min(1,this.axisY))):(this.axisX=0,this.axisY=0)}}class E{keys=new Set;touchControls;constructor(){this.touchControls=new A,window.addEventListener("keydown",t=>{this.keys.add(t.code)}),window.addEventListener("keyup",t=>{this.keys.delete(t.code)})}isKeyDown(t){return this.keys.has(t)}isMobile(){return this.touchControls.isTouchActive}getAxis(){let t=0,e=0;if((this.isKeyDown("KeyW")||this.isKeyDown("ArrowUp"))&&(e-=1),(this.isKeyDown("KeyS")||this.isKeyDown("ArrowDown"))&&(e+=1),(this.isKeyDown("KeyA")||this.isKeyDown("ArrowLeft"))&&(t-=1),(this.isKeyDown("KeyD")||this.isKeyDown("ArrowRight"))&&(t+=1),t!==0&&e!==0){const i=Math.sqrt(t*t+e*e);t/=i,e/=i}return(this.touchControls.axisX!==0||this.touchControls.axisY!==0)&&(t=this.touchControls.axisX,e=this.touchControls.axisY),{x:t,y:e}}}class I{x;y;width;height;color;isMarkedForDeletion=!1;constructor(t,e,i,s,a){this.x=t,this.y=e,this.width=i,this.height=s,this.color=a}update(t,...e){}draw(t){const e=t.getContext();e.fillStyle=this.color,e.fillRect(this.x,this.y,this.width,this.height)}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}const S={WARRIOR:{hp:150,maxHp:150,damage:25,speed:180,attackSpeed:1.5,color:"#e74c3c",projectileCount:0,auraDamage:0,auraRange:0},ARCHER:{hp:80,maxHp:80,damage:15,speed:240,attackSpeed:2.5,color:"#2ecc71",projectileCount:1,auraDamage:0,auraRange:0},MAGE:{hp:60,maxHp:60,damage:35,speed:200,attackSpeed:1.2,color:"#3498db",projectileCount:1,auraDamage:0,auraRange:0}};class k extends I{stats;classType;xp=0;level=1;nextLevelXp=100;cooldownTimer=0;invulnerabilityTimer=0;image=null;constructor(t,e,i){const s=S[i];super(t,e,48,48,s.color),this.classType=i,this.stats={...s},i==="ARCHER"?(this.image=new Image,this.image.src="/arqueiro.png"):i==="WARRIOR"?(this.image=new Image,this.image.src="/guerreiro.png"):i==="MAGE"&&(this.image=new Image,this.image.src="/mago.png")}update(t,e){const i=e.getAxis();this.x+=i.x*this.stats.speed*t,this.y+=i.y*this.stats.speed*t,this.cooldownTimer>0&&(this.cooldownTimer-=t),this.invulnerabilityTimer>0&&(this.invulnerabilityTimer-=t)}canShoot(){return this.cooldownTimer<=0}takeDamage(t){return this.invulnerabilityTimer>0?!1:(this.stats.hp-=t,this.invulnerabilityTimer=.5,!0)}resetCooldown(){this.cooldownTimer=1/this.stats.attackSpeed}gainXp(t){return this.xp+=t,this.xp>=this.nextLevelXp?(this.xp-=this.nextLevelXp,this.level++,this.nextLevelXp=Math.floor(this.nextLevelXp*1.5),!0):!1}draw(t){this.image&&this.image.complete?t.getContext().drawImage(this.image,this.x,this.y,this.width,this.height):super.draw(t)}}class f extends I{hp;maxHp;speed;damage;static zombieImage=null;constructor(t,e){super(t,e,48,48,"#ff0000"),this.hp=50,this.maxHp=50,this.speed=100,this.damage=10,f.zombieImage||(f.zombieImage=new Image,f.zombieImage.src="/zombie.png")}update(t,e){const i=e.x-this.x,s=e.y-this.y,a=Math.sqrt(i*i+s*s);a>0&&(this.x+=i/a*this.speed*t,this.y+=s/a*this.speed*t)}draw(t){f.zombieImage&&f.zombieImage.complete?t.getContext().drawImage(f.zombieImage,this.x,this.y,this.width,this.height):super.draw(t)}}class d extends I{vx;vy;damage;isPlayerOwned;homing=!1;target=null;lifeTime=2;static arrowImage=null;static fireballImage=null;static swordImage=null;isArrow=!1;isFireball=!1;isSword=!1;constructor(t,e,i,s,a,o,p=!1,u=null,r=!1,h=!1,c=!1){super(t,e,8,8,o?"#ffff00":"#ff00ff"),this.vx=i,this.vy=s,this.damage=a,this.isPlayerOwned=o,this.homing=p,this.target=u,this.isArrow=r,this.isFireball=h,this.isSword=c,d.arrowImage||(d.arrowImage=new Image,d.arrowImage.src="/flecha.png"),d.fireballImage||(d.fireballImage=new Image,d.fireballImage.src="/bola_de_fogo.png"),d.swordImage||(d.swordImage=new Image,d.swordImage.src="/espada_guerreiro.png")}update(t){if(this.homing&&this.target&&!this.target.isMarkedForDeletion){const e=this.target.x-this.x,i=this.target.y-this.y,s=Math.sqrt(e*e+i*i);if(s>0){const a=Math.sqrt(this.vx*this.vx+this.vy*this.vy);this.vx=e/s*a,this.vy=i/s*a}}this.x+=this.vx*t,this.y+=this.vy*t,this.lifeTime-=t,this.lifeTime<=0&&(this.isMarkedForDeletion=!0)}draw(t){if(this.isArrow&&d.arrowImage&&d.arrowImage.complete){const e=t.getContext(),i=Math.atan2(this.vy,this.vx);e.save(),e.translate(this.x+this.width/2,this.y+this.height/2),e.rotate(i),e.drawImage(d.arrowImage,-12,-12,24,24),e.restore()}else if(this.isFireball&&d.fireballImage&&d.fireballImage.complete){const e=t.getContext(),i=Math.atan2(this.vy,this.vx);e.save(),e.translate(this.x+this.width/2,this.y+this.height/2),e.rotate(i),e.drawImage(d.fireballImage,-16,-16,32,32),e.restore()}else if(this.isSword&&d.swordImage&&d.swordImage.complete){const e=t.getContext(),i=Math.atan2(this.vy,this.vx);e.save(),e.translate(this.x+this.width/2,this.y+this.height/2),e.rotate(i),e.drawImage(d.swordImage,-20,-20,40,40),e.restore()}else super.draw(t)}}class L{uiLayer;modalLayer;constructor(){this.uiLayer=document.getElementById("ui-layer"),this.modalLayer=document.getElementById("modal-layer"),this.setupHUD()}setupHUD(){this.uiLayer.innerHTML=`
      <div style="position: absolute; top: 10px; left: 10px; color: white; font-family: sans-serif;">
        <div id="hp-bar" style="width: 200px; height: 20px; background: #333; border: 1px solid #fff;">
          <div id="hp-fill" style="width: 100%; height: 100%; background: #e74c3c;"></div>
        </div>
        <div style="margin-top: 5px;">Level: <span id="level-display">1</span></div>
        <div id="xp-bar" style="width: 200px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 5px;">
          <div id="xp-fill" style="width: 0%; height: 100%; background: #f1c40f;"></div>
        </div>
      </div>
      
      <!-- Wave Counter -->
      <div id="wave-counter" style="
        position: absolute; 
        top: 15px; 
        left: 50%; 
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 30px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        font-family: 'Arial', sans-serif;
        color: white;
        font-weight: bold;
        font-size: 18px;
        text-align: center;
        border: 2px solid rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
      ">
        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 2px;">FASE</div>
        <div id="wave-number" style="font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">1</div>
      </div>
    `}updateHUD(t){const e=document.getElementById("hp-fill"),i=document.getElementById("xp-fill"),s=document.getElementById("level-display");if(e){const a=Math.max(0,t.stats.hp/t.stats.maxHp*100);e.style.width=`${a}%`}if(i){const a=t.xp/t.nextLevelXp*100;i.style.width=`${a}%`}s&&(s.innerText=t.level.toString())}updateWave(t){const e=document.getElementById("wave-number");e&&(e.innerText=t.toString())}updateObjective(t,e,i,s,a){let o=document.getElementById("objective-display");if(o||(o=document.createElement("div"),o.id="objective-display",o.style.cssText=`
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0,0,0,0.7);
        padding: 10px 20px;
        border-radius: 15px;
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        text-align: center;
        border: 2px solid rgba(255,255,255,0.2);
      `,this.uiLayer.appendChild(o)),t==="ELIMINATION"){const p=Math.min(100,e/i*100);o.innerHTML=`
        <div style="margin-bottom: 5px; font-weight: bold;">OBJETIVO: Eliminar ${i} Zumbis</div>
        <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #e74c3c, #c0392b); height: 100%; width: ${p}%;"></div>
        </div>
        <div style="margin-top: 5px; font-size: 12px;">${e} / ${i}</div>
      `}else{const p=Math.max(0,a-s),u=Math.floor(p/60),r=Math.floor(p%60),h=Math.min(100,s/a*100);o.innerHTML=`
        <div style="margin-bottom: 5px; font-weight: bold;">OBJETIVO: Sobreviver por 3 Minutos</div>
        <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #3498db, #2980b9); height: 100%; width: ${h}%;"></div>
        </div>
        <div style="margin-top: 5px; font-size: 12px;">${u}:${r.toString().padStart(2,"0")} restantes</div>
      `}}showClassSelection(t){this.modalLayer.innerHTML=`
      <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #242424; display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <h1 style="color: white; margin-bottom: 40px; font-size: 3em;">Escolha Sua Classe</h1>
        <div style="display: flex; gap: 30px;">
          <div class="class-card" data-class="WARRIOR" style="width: 200px; padding: 20px; background: #c0392b; cursor: pointer; border-radius: 10px; text-align: center; color: white;">
            <h2>Guerreiro</h2>
            <p>Combate Corpo a Corpo</p>
            <p>HP Alto</p>
          </div>
          <div class="class-card" data-class="ARCHER" style="width: 200px; padding: 20px; background: #27ae60; cursor: pointer; border-radius: 10px; text-align: center; color: white;">
            <h2>Arqueiro</h2>
            <p>Flechas Teleguiadas</p>
            <p>Velocidade Alta</p>
          </div>
          <div class="class-card" data-class="MAGE" style="width: 200px; padding: 20px; background: #2980b9; cursor: pointer; border-radius: 10px; text-align: center; color: white;">
            <h2>Mago</h2>
            <p>Magia Teleguiada</p>
            <p>Dano Alto</p>
          </div>
        </div>
      </div>
    `,this.modalLayer.querySelectorAll(".class-card").forEach(i=>{i.addEventListener("click",()=>{const s=i.getAttribute("data-class");t(s),this.hideCardSelection()}),i.addEventListener("mouseenter",()=>{i.style.transform="scale(1.05)"}),i.addEventListener("mouseleave",()=>{i.style.transform="scale(1)"})})}showCardSelection(t,e){this.modalLayer.innerHTML=`
      <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <h2 style="color: white; margin-bottom: 20px;">Subiu de Nível! Escolha uma Carta</h2>
        <div style="display: flex; gap: 20px;">
          ${t.map((s,a)=>`
            <div class="card" data-index="${a}" style="width: 200px; height: 300px; background: #2c3e50; border: 2px solid #ecf0f1; border-radius: 10px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center; color: white; transition: transform 0.2s;">
              <h3 style="color: #f1c40f;">${s.name}</h3>
              <p style="font-size: 0.8em; color: #bdc3c7;">${s.type}</p>
              <p style="margin-top: 20px;">${s.description}</p>
            </div>
          `).join("")}
        </div>
      </div>
    `,this.modalLayer.querySelectorAll(".card").forEach(s=>{s.addEventListener("click",()=>{const a=parseInt(s.getAttribute("data-index")||"0");e(t[a]),this.hideCardSelection()}),s.addEventListener("mouseenter",()=>{s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.transform="scale(1)"})})}showGameOver(t){this.modalLayer.innerHTML=`
      <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <h1 style="color: #e74c3c; font-size: 64px; margin-bottom: 20px;">FIM DE JOGO</h1>
        <button id="restart-btn" style="padding: 15px 40px; font-size: 24px; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 8px;">
          Reiniciar
        </button>
      </div>
    `,document.getElementById("restart-btn").addEventListener("click",t)}showPauseMenu(t){this.modalLayer.innerHTML=`
      <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <h1 style="color: white; font-size: 64px; margin-bottom: 40px;">PAUSADO</h1>
        <button id="resume-btn" style="padding: 15px 40px; font-size: 24px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 8px; margin-bottom: 20px;">
          Continuar (ESC)
        </button>
        <button id="restart-pause-btn" style="padding: 15px 40px; font-size: 24px; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 8px;">
          Reiniciar Jogo
        </button>
      </div>
    `,document.getElementById("resume-btn").addEventListener("click",t),document.getElementById("restart-pause-btn").addEventListener("click",()=>{location.reload()})}hidePauseMenu(){this.modalLayer.innerHTML=""}hideCardSelection(){this.modalLayer.innerHTML=""}}const D=[{id:"atk_boost",name:"Treinamento de Força",type:"ATTRIBUTE",description:"+20% de Dano",apply:n=>{n.stats.damage*=1.2}},{id:"spd_boost",name:"Leveza",type:"ATTRIBUTE",description:"+15% de Velocidade",apply:n=>{n.stats.speed*=1.15}},{id:"hp_boost",name:"Vitalidade",type:"ATTRIBUTE",description:"+30% de HP Máximo",apply:n=>{n.stats.maxHp*=1.3,n.stats.hp=n.stats.maxHp}},{id:"atk_spd",name:"Frenesi",type:"ATTRIBUTE",description:"+15% de Velocidade de Ataque",apply:n=>{n.stats.attackSpeed*=1.15}},{id:"multishot",name:"Tiro Múltiplo",type:"SKILL",description:"+1 Projétil",apply:n=>{n.stats.projectileCount+=1}},{id:"aura",name:"Aura Flamejante",type:"SKILL",description:"Causa dano a inimigos próximos",apply:n=>{n.stats.auraRange===0?(n.stats.auraRange=100,n.stats.auraDamage=5):(n.stats.auraRange*=1.2,n.stats.auraDamage*=1.5)}},{id:"crit_chance",name:"Precisão",type:"PASSIVE",description:"Ataques têm chance de causar dano dobrado (Não implementado ainda)",apply:n=>{}}];class R{getRandomCards(t){return[...D].sort(()=>.5-Math.random()).slice(0,t)}applyCard(t,e){e.apply(t),console.log(`Applied card: ${e.name}`)}}class y{renderer;input;ui;cardManager;lastTime=0;player;enemies=[];projectiles=[];spawnTimer=0;isPaused=!1;state="MENU";gameTime=0;auraTickTimer=0;currentWave=1;enemiesSpawnedThisWave=0;enemiesPerWave=10;waveObjective="ELIMINATION";waveStartTime=0;killsThisWave=0;SURVIVAL_TIME=180;ELIMINATION_TARGET=100;hordeTimer=0;HORDE_INTERVAL=30;HORDE_SIZE=20;HORDE_WARNING_TIME=3;showHordeWarning=!1;static hordeWarningImage=null;static sirenSound=null;sirenPlayed=!1;escPressed=!1;constructor(){this.renderer=new T("gameCanvas"),this.input=new E,this.ui=new L,this.cardManager=new R,y.hordeWarningImage||(y.hordeWarningImage=new Image,y.hordeWarningImage.src="/hordas_chegando_aviso.png"),y.sirenSound||(y.sirenSound=new Audio,this.createSirenSound()),this.ui.showClassSelection(t=>{this.startGame(t)}),requestAnimationFrame(t=>this.loop(t))}startGame(t){this.player=new k(this.renderer.width/2-16,this.renderer.height/2-16,t),this.state="PLAYING",this.waveStartTime=0}createSirenSound(){if(!y.sirenSound)return;const t=new(window.AudioContext||window.webkitAudioContext),e=2,i=t.sampleRate,s=t.createBuffer(1,e*i,i),a=s.getChannelData(0);for(let u=0;u<s.length;u++){const r=u/i,h=400+Math.sin(r*4)*200;a[u]=Math.sin(2*Math.PI*h*r)*.3}const o=this.bufferToWave(s,s.length),p=new Blob([o],{type:"audio/wav"});y.sirenSound.src=URL.createObjectURL(p),y.sirenSound.volume=.4}bufferToWave(t,e){const i=t.numberOfChannels,s=e*i*2+44,a=new ArrayBuffer(s),o=new DataView(a),p=[];let u=0,r=0;const h=l=>{o.setUint16(r,l,!0),r+=2},c=l=>{o.setUint32(r,l,!0),r+=4};c(1179011410),c(s-8),c(1163280727),c(544501094),c(16),h(1),h(i),c(t.sampleRate),c(t.sampleRate*2*i),h(i*2),h(16),c(1635017060),c(s-r-4);for(let l=0;l<t.numberOfChannels;l++)p.push(t.getChannelData(l));for(;r<s;){for(let l=0;l<i;l++){let x=Math.max(-1,Math.min(1,p[l][u]));x=x<0?x*32768:x*32767,o.setInt16(r,x,!0),r+=2}u++}return a}loop(t){const e=(t-this.lastTime)/1e3;this.lastTime=t,this.state==="PLAYING"&&!this.isPaused&&this.player&&this.update(e),this.state==="PLAYING"&&this.player&&(this.input.isKeyDown("Escape")&&!this.escPressed?(this.escPressed=!0,this.togglePause()):this.input.isKeyDown("Escape")||(this.escPressed=!1)),this.draw(),requestAnimationFrame(i=>this.loop(i))}update(t){if(!this.player)return;this.gameTime+=t,this.waveStartTime+=t,this.player.update(t,this.input),this.player.stats.auraRange>0&&(this.auraTickTimer+=t,this.auraTickTimer>=.5&&(this.auraTickTimer=0,this.enemies.forEach(r=>{if(!this.player)return;Math.sqrt(Math.pow(r.x-this.player.x,2)+Math.pow(r.y-this.player.y,2))<=this.player.stats.auraRange&&(r.hp-=this.player.stats.auraDamage,r.hp<=0&&(r.isMarkedForDeletion=!0,this.killsThisWave++,this.player.gainXp(20)&&this.triggerLevelUp()))})));const e=this.input.isMobile(),i=this.input.getAxis(),s=i.x!==0||i.y!==0;if((this.input.isKeyDown("KeyJ")||e&&!s)&&this.player.canShoot())if(this.player.resetCooldown(),this.player.classType==="WARRIOR"){let r=0,h=0,c=null,l=1/0;for(const g of this.enemies){const m=Math.sqrt(Math.pow(g.x-this.player.x,2)+Math.pow(g.y-this.player.y,2));m<l&&(l=m,c=g)}if(c){const g=c.x-this.player.x,m=c.y-this.player.y,b=Math.sqrt(g*g+m*m);r=g/b,h=m/b}else this.input.isKeyDown("ArrowUp")||this.input.isKeyDown("KeyW")?h=-1:this.input.isKeyDown("ArrowDown")||this.input.isKeyDown("KeyS")?h=1:this.input.isKeyDown("ArrowLeft")||this.input.isKeyDown("KeyA")?r=-1:(this.input.isKeyDown("ArrowRight")||this.input.isKeyDown("KeyD"),r=1);const x=new d(this.player.x+16+r*50,this.player.y+16+h*50,r*10,h*10,this.player.stats.damage,!0,!1,null,!1,!1,!0);x.lifeTime=.2,this.projectiles.push(x)}else{const r=Math.max(1,this.player.stats.projectileCount);for(let h=0;h<r;h++){const c=h*500;setTimeout(()=>{if(!this.player)return;let l=null,x=1/0;for(const w of this.enemies){const v=Math.sqrt(Math.pow(w.x-this.player.x,2)+Math.pow(w.y-this.player.y,2));v<x&&(x=v,l=w)}let g=0,m=0;if(l){const w=l.x-this.player.x,v=l.y-this.player.y,M=Math.sqrt(w*w+v*v);g=w/M,m=v/M}else this.input.isKeyDown("ArrowUp")||this.input.isKeyDown("KeyW")?m=-1:this.input.isKeyDown("ArrowDown")||this.input.isKeyDown("KeyS")?m=1:this.input.isKeyDown("ArrowLeft")||this.input.isKeyDown("KeyA")?g=-1:(this.input.isKeyDown("ArrowRight")||this.input.isKeyDown("KeyD"),g=1);const b=600;if(g!==0&&m!==0&&!l){const w=Math.sqrt(g*g+m*m);g/=w,m/=w}this.projectiles.push(new d(this.player.x+16,this.player.y+16,g*b,m*b,this.player.stats.damage,!0,!0,l,this.player.classType==="ARCHER",this.player.classType==="MAGE"))},c)}}this.projectiles.forEach(r=>r.update(t)),this.projectiles=this.projectiles.filter(r=>!r.isMarkedForDeletion),this.player&&this.enemies.forEach(r=>r.update(t,this.player));const o=2,p=Math.max(.2,1-this.gameTime/30*.1),u=Math.max(.5,o*p);this.spawnTimer+=t,this.spawnTimer>u&&(this.spawnTimer=0,this.spawnEnemy(),this.enemiesSpawnedThisWave++),this.hordeTimer+=t,this.hordeTimer>=this.HORDE_INTERVAL-this.HORDE_WARNING_TIME&&this.hordeTimer<this.HORDE_INTERVAL?(this.showHordeWarning||(this.showHordeWarning=!0,this.sirenPlayed=!1),!this.sirenPlayed&&y.sirenSound&&(y.sirenSound.currentTime=0,y.sirenSound.play().catch(r=>console.log("Audio play failed:",r)),this.sirenPlayed=!0)):this.showHordeWarning=!1,this.hordeTimer>=this.HORDE_INTERVAL&&(this.hordeTimer=0,this.showHordeWarning=!1,this.sirenPlayed=!1,this.spawnHorde()),this.checkWaveCompletion(),this.checkCollisions(),this.ui.updateHUD(this.player),this.ui.updateWave(this.currentWave),this.ui.updateObjective(this.waveObjective,this.killsThisWave,this.ELIMINATION_TARGET,this.waveStartTime,this.SURVIVAL_TIME)}checkWaveCompletion(){let t=!1;this.waveObjective==="ELIMINATION"?this.killsThisWave>=this.ELIMINATION_TARGET&&(t=!0):this.waveStartTime>=this.SURVIVAL_TIME&&(t=!0),t&&this.nextWave()}nextWave(){this.currentWave++,this.enemiesSpawnedThisWave=0,this.killsThisWave=0,this.waveStartTime=0,this.waveObjective=this.currentWave%5===0?"SURVIVAL":"ELIMINATION",this.enemiesPerWave=Math.floor(this.enemiesPerWave*1.2),this.triggerWaveReward()}triggerWaveReward(){if(!this.player)return;this.isPaused=!0;const t=this.cardManager.getRandomCards(3);this.ui.showCardSelection(t,e=>{this.player&&this.cardManager.applyCard(this.player,e),this.isPaused=!1})}spawnEnemy(){const t=Math.floor(Math.random()*4);let e=0,i=0;switch(t){case 0:e=Math.random()*this.renderer.width,i=-50;break;case 1:e=Math.random()*this.renderer.width,i=this.renderer.height+50;break;case 2:e=-50,i=Math.random()*this.renderer.height;break;case 3:e=this.renderer.width+50,i=Math.random()*this.renderer.height;break}this.enemies.push(new f(e,i))}spawnHorde(){const t=Math.floor(this.HORDE_SIZE/4);for(let e=0;e<t;e++){const i=this.renderer.width/t*e;this.enemies.push(new f(i,-50))}for(let e=0;e<t;e++){const i=this.renderer.width/t*e;this.enemies.push(new f(i,this.renderer.height+50))}for(let e=0;e<t;e++){const i=this.renderer.height/t*e;this.enemies.push(new f(-50,i))}for(let e=0;e<t;e++){const i=this.renderer.height/t*e;this.enemies.push(new f(this.renderer.width+50,i))}}checkCollisions(){if(this.player){for(const t of this.projectiles)if(t.isPlayerOwned)for(const e of this.enemies)this.isColliding(t,e)&&(e.hp-=t.damage,t.isMarkedForDeletion=!0,e.hp<=0&&(e.isMarkedForDeletion=!0,this.killsThisWave++,this.player.gainXp(20)&&this.triggerLevelUp()));this.enemies=this.enemies.filter(t=>!t.isMarkedForDeletion);for(const t of this.enemies){const e=t.x+t.width/2,i=t.y+t.height/2,s=this.player.x+this.player.width/2,a=this.player.y+this.player.height/2;if(Math.sqrt(Math.pow(s-e,2)+Math.pow(a-i,2))<20&&this.player.takeDamage(10)){const p=this.player.x-t.x,u=this.player.y-t.y,r=Math.sqrt(p*p+u*u);r>0&&(this.player.x+=p/r*20,this.player.y+=u/r*20),this.player.stats.hp<=0&&this.gameOver()}}}}gameOver(){this.isPaused=!0,this.ui.showGameOver(()=>{location.reload()})}triggerLevelUp(){if(!this.player)return;this.isPaused=!0;const t=this.cardManager.getRandomCards(3);this.ui.showCardSelection(t,e=>{this.player&&this.cardManager.applyCard(this.player,e),this.isPaused=!1})}togglePause(){this.isPaused=!this.isPaused,this.isPaused?this.ui.showPauseMenu(()=>{this.isPaused=!1}):this.ui.hidePauseMenu()}isColliding(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}draw(){if(this.renderer.clear(),this.player&&this.player.stats.auraRange>0){const t=this.renderer.getContext();t.beginPath(),t.arc(this.player.x+16,this.player.y+16,this.player.stats.auraRange,0,Math.PI*2),t.fillStyle="rgba(231, 76, 60, 0.2)",t.fill(),t.strokeStyle="rgba(231, 76, 60, 0.5)",t.lineWidth=2,t.stroke()}if(this.player&&this.player.draw(this.renderer),this.enemies.forEach(t=>t.draw(this.renderer)),this.projectiles.forEach(t=>t.draw(this.renderer)),this.showHordeWarning&&y.hordeWarningImage&&y.hordeWarningImage.complete){const t=this.renderer.getContext(),e=400,i=200,s=(this.renderer.width-e)/2,a=(this.renderer.height-i)/2;t.drawImage(y.hordeWarningImage,s,a,e,i)}}}window.addEventListener("DOMContentLoaded",()=>{new y});
